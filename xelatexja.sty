%%
%% This is file `xelatexja.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% xelatexja.dtx  (with options: `package')
%% 
%% Copyright (c) 2021 Yukimasa Morimi (h20y6m)
%%   GitHub:   https://github.com/h20y6m
%% 
%% This package is distributed under the MIT License.
%% 
%% File: xelatexja.dtx
\NeedsTeXFormat{LaTeX2e}[2021-06-01]
\RequirePackage{expl3}[2021-07-12]
\ProvidesExplPackage{xelatexja}
  {2021/08/15}{0.1.0}{Japanese typesetting with XeLaTeX}
\msg_new:nnn { xelatexja } { needs-xetex }
  { XeLaTeX-ja~needs~XeTeX. }
\sys_if_engine_xetex:F
  {
    \msg_critical:nn { xelatexja } { needs-xetex }
  }
\RequirePackage{l3keys2e,xparse}
\bool_new:N \g__xeja_tate_document_bool
\bool_new:N \l__xeja_tate_text_bool
\fp_new:N \g__xeja_jascale_fp
\fp_gset:Nn \g__xeja_jascale_fp { 1 }
\dim_new:N \l_xeja_zw_dim
\cs_new_eq:NN \zw \l_xeja_zw_dim
\tl_new:N \l__xeja_kanjiskip_tl
\tl_set:Nn \l__xeja_kanjiskip_tl { 0\zw plus 0.25\zw }
\tl_new:N \l__xeja_xkanjiskip_tl
\tl_set:Nn \l__xeja_xkanjiskip_tl { 0.25\zw plus 0.25\zw minus 0.125\zw }
\tl_new:N \g__xeja_jfm_tl
\tl_new:N \l__xeja_ybaselineshift_tl
\tl_new:N \l__xeja_tbaselineshift_tl
\tl_set:Nn \l__xeja_ybaselineshift_tl { 0\zw }
\tl_set:Nn \l__xeja_tbaselineshift_tl { 0.38\zw }
\tl_new:N \l__xeja_tmpa_tl
\tl_new:N \l__xeja_tmpb_tl
\dim_new:N \l__xeja_tmpa_dim
\keys_define:nn { xelatexja }
  {
    tate .bool_gset:N = \g__xeja_tate_document_bool,
    jascale .fp_gset:N = \g__xeja_jascale_fp,
    jfm .tl_gset:N = \g__xeja_jfm_tl,
  }
\keys_set:nn { xelatexja } { jfm = standard }
\ProcessKeysOptions { xelatexja }
\bool_set_eq:NN \l__xeja_tate_text_bool \g__xeja_tate_document_bool
\prg_new_conditional:Npnn \xeja_if_tate_document: { p, T, F, TF }
  {
    \bool_if:NTF \g__xeja_tate_document_bool
      { \prg_return_true: } { \prg_return_false: }
  }
\prg_new_conditional:Npnn \xeja_if_tate_text: { p, T, F, TF }
  {
    \bool_if:NTF \l__xeja_tate_text_bool
      { \prg_return_true: } { \prg_return_false: }
  }
\cs_new:Npn \xeja_get_jascale:
  { \fp_use:N \g__xeja_jascale_fp }
\cs_new:Npn \__xeja_update_zw:
  {
    \dim_set:Nn \l_xeja_zw_dim
      { \fp_to_dim:n { \g__xeja_jascale_fp * \f@size } }
  }
\__xeja_update_zw:
\hook_gput_code:nnn { selectfont } { . }
  { \__xeja_update_zw: }
\str_const:Nn \c_xeja_yoko_encoding_str { JY4 }
\str_const:Nn \c_xeja_tate_encoding_str { JT4 }
\prop_new:N \g__xeja_kanji_family_prop
\prop_new:N \g__xeja_kanji_shape_prop
\tl_new:N \l__xeja_kanji_family_tl
\cs_new:Npn \xeja_declare_kanji_family:nn #1#2
  {
    \prop_gput:Nnn \g__xeja_kanji_family_prop {#1} {#2}
  }
\cs_generate_variant:Nn \xeja_declare_kanji_family:nn { xn }
\cs_new:Npn \xeja_declare_kanji_shape:nnnn #1#2#3#4
  {
    \prop_gput:Nnn \g__xeja_kanji_shape_prop { #1 / #2 / #3 } {#4}
  }
\cs_generate_variant:Nn \xeja_declare_kanji_shape:nnnn { xxxx }
\cs_new:Npn \xeja_kanji_family:n #1
  {
    \tl_set:Nx \l__xeja_kanji_family_tl {#1}
  }
\cs_new:Npn \__xeja_new_kanji_font:Nnn #1#2#3
  {
    \tex_global:D
    \tex_font:D #1 = "#2" ~ at ~ \fp_to_dim:n { \g__xeja_jascale_fp * #3 } ~
  }
\cs_generate_variant:Nn \__xeja_new_kanji_font:Nnn { Nxn, cxn }
\tl_new:N \l__xeja_kanji_default_shape_tl
\tl_new:N \l__xeja_kanji_font_shape_tl
\tl_new:N \l__xeja_kanji_font_name_tl
\cs_new:Npn \__xeja_select_kanji_font_aux:nnnnnn #1#2#3#4#5#6
  {
    \cs_if_exist:cF
      { #1 / #2 / #3 / #4 / #5 }
      {
        \exp_args:Ncx \__xeja_select_kanji_font_aux_ii:NnnnF
          { #1 / #2 / #3 / #4 / #5 }
          { #2 / #3 / #4 }
          {#5}
          {#6}
          {
            \exp_args:Ncx \__xeja_select_kanji_font_aux_ii:NnnnTF
              { #1 / #2 / #3 / #4 / #5 }
              { #2 / #3 / n }
              {#5}
              {#6}
              {
                \msg_warning:nnxx { xelatexja } { font / instead }
                  { #2 / #3 / #4 }
                  { #2 / #3 / n }
              }
              {
                \exp_args:Ncx \__xeja_select_kanji_font_aux_ii:NnnnTF
                  { #1 / #2 / #3 / #4 / #5 }
                  { #2 / m / n }
                  {#5}
                  {#6}
                  {
                    \msg_warning:nnxx { xelatexja } { font / instead }
                      { #2 / #3 / #4 }
                      { #2 / m / n }
                  }
                  {
                    \msg_warning:nnx { xelatexja } { font / undefined }
                      { #2 / #3 / #4 }
                    \cs_gset_eq:cN { #1 / #2 / #3 / #4 / #5 }
                      \prg_do_nothing:
                  }
              }
          }
      }
    \use:c { #1 / #2 / #3 / #4 / #5 }
  }
\prg_new_conditional:Npnn \__xeja_select_kanji_font_aux_ii:Nnnn #1#2#3#4
  { T, F, TF }
  {
    \prop_get:NnNTF \g__xeja_kanji_shape_prop {#2}
      \l__xeja_tmpa_tl
      {
        \tl_if_empty:nF {#4}
          {
            \tl_if_in:NnTF \l__xeja_tmpa_tl { : }
              { \tl_put_right:Nn \l__xeja_tmpa_tl { , #4 } }
              { \tl_put_right:Nn \l__xeja_tmpa_tl { : #4 } }
          }
        \__xeja_new_kanji_font:Nxn #1
          { \l__xeja_tmpa_tl }
          {#3}
        \prg_return_true:
      }
      {
        \prg_return_false:
      }
  }
\msg_new:nnn { xelatexja } { font / instead }
  { Kanji~shape~`#1'~undefined.~using `#2'~instead. }
\msg_new:nnn { xelatexja } { font / undefined }
  { Kanji~shape~`#1'~undefined. }
\cs_new:Npn \__xeja_select_yoko_kanji_font:
  {
    \__xeja_select_kanji_font_aux:nnnnnn
      { \c_xeja_yoko_encoding_str }
      { \l__xeja_kanji_family_tl }
      { \f@series }
      { \f@shape }
      { \f@size }
      {}
  }
\cs_new:Npn \__xeja_select_tate_kanji_font:
  {
    \__xeja_select_kanji_font_aux:nnnnnn
      { \c_xeja_tate_encoding_str }
      { \l__xeja_kanji_family_tl }
      { \f@series }
      { \f@shape }
      { \f@size }
      { vertical }
  }
\xeja_declare_kanji_family:nn { mc } {}
\xeja_declare_kanji_family:nn { gt } {}
\xeja_declare_kanji_shape:nnnn { mc } { m } { n }
  { [HaranoAjiMincho-Regular.otf]:+fwid }
\xeja_declare_kanji_shape:nnnn { gt } { m } { n }
  { [HaranoAjiGothic-Medium.otf]:+fwid }
\xeja_declare_kanji_shape:nnnn { mc } { b } { n }
  { [HaranoAjiGothic-Medium.otf]:+fwid }
\xeja_declare_kanji_shape:nnnn { gt } { b } { n }
  { [HaranoAjiGothic-Medium.otf]:+fwid }
\xeja_declare_kanji_shape:nnnn { mc } { bx } { n }
  { [HaranoAjiGothic-Medium.otf]:+fwid }
\xeja_declare_kanji_shape:nnnn { gt } { bx } { n }
  { [HaranoAjiGothic-Medium.otf]:+fwid }
\xeja_kanji_family:n { mc }
\cs_new:Npn \__xeja_enter_kanji_font:
  {
    \bool_if:NTF \l__xeja_tate_text_bool
      { \__xeja_select_tate_kanji_font: }
      { \__xeja_select_yoko_kanji_font: }
  }
\cs_new:Npn \__xeja_leave_kanji_font:
  {
    \selectfont
  }
\tex_XeTeXinterchartokenstate:D = 1 ~
\seq_new:N \g__xeja_class_seq
\msg_new:nnnn { xelatexja } { class-exists }
  { Class~'#1'~has~already~been~declared. }
  {
    There~already~exists~a~class~declaration~with~this~name.\\
    Please~use~a~different~name~for~your~class.
  }
\cs_new:Npn \__xeja_class_new:n #1
  {
    \seq_if_in:NnTF \g__xeja_class_seq {#1}
      {
        \msg_error:nnn { xelatexja } { class-exists } {#1}
      }
      {
        \exp_args:Nc
          \newXeTeXintercharclass
          { c__xeja_class_#1_int }
        \seq_gput_right:Nn \g__xeja_class_seq {#1}
      }
  }
\cs_new:Npn \__xeja_class_new:nn #1#2
  {
    \seq_if_in:NnTF \g__xeja_class_seq {#1}
      {
        \msg_error:nnn { xelatexja } { class-exists } {#1}
      }
      {
        \int_const:cn
          { c__xeja_class_#1_int }
          {#2}
        \seq_gput_right:Nn \g__xeja_class_seq {#1}
      }
  }
\cs_new:Npn \__xeja_class_use:n #1
  {
    \int_use:c
      { c__xeja_class_#1_int }
  }
\seq_new:N \g__xeja_class_kanji_seq
\seq_new:N \g__xeja_class_alpha_seq
\cs_new:Npn \xeja_class_new_kanji:n #1
  {
    \__xeja_class_new:n {#1}
    \seq_gput_right:Nn \g__xeja_class_kanji_seq {#1}
  }
\cs_new:Npn \xeja_class_new_alpha:n #1
  {
    \__xeja_class_new:n {#1}
    \seq_gput_right:Nn \g__xeja_class_alpha_seq {#1}
  }
\cs_new:Npn \xeja_class_new_kanji:nn #1#2
  {
    \__xeja_class_new:nn {#1} {#2}
    \seq_gput_right:Nn \g__xeja_class_kanji_seq {#1}
  }
\cs_new:Npn \xeja_class_new_alpha:nn #1#2
  {
    \__xeja_class_new:nn {#1} {#2}
    \seq_gput_right:Nn \g__xeja_class_alpha_seq {#1}
  }
\xeja_class_new_kanji:n { kanji/default }
\xeja_class_new_alpha:nn { alpha/default } { 0 }
\__xeja_class_new:nn { boundary } { 4095 }
\__xeja_class_new:nn { ignored } { 4096 }
\cs_new:Npn \xeja_char_set_class:nn #1#2
  {
    \tex_XeTeXcharclass:D \int_eval:n {#1} = \__xeja_class_use:n {#2} ~
  }
\cs_new:Npn \xeja_char_set_class_range:nnn #1#2#3
  {
    \int_step_inline:nnn {#1} {#2}
      {
        \xeja_char_set_class:nn {##1} {#3}
      }
  }
\cs_new:Npn \xeja_class_update:
  {
    \seq_map_inline:Nn \g__xeja_class_kanji_seq
      {
        \seq_map_inline:Nn \g__xeja_class_kanji_seq
          {
            \__xeja_interchar_gset:nnn {##1} {####1}
              { \__xeja_interchar_kanji_to_kanji:nn {##1} {####1} }
          }
        \seq_map_inline:Nn \g__xeja_class_alpha_seq
          {
            \__xeja_interchar_gset:nnn {##1} {####1}
              { \__xeja_interchar_kanji_to_alpha:nn {##1} {####1} }
            \__xeja_interchar_gset:nnn {####1} {##1}
              { \__xeja_interchar_alpha_to_kanji:nn {####1} {##1} }
          }
        \__xeja_interchar_gset:nnn {##1} { boundary }
          { \__xeja_interchar_kanji_to_boundary:n {##1} }
        \__xeja_interchar_gset:nnn { boundary } {##1}
          { \__xeja_interchar_boundary_to_kanji:n {##1} }
      }
    \seq_map_inline:Nn \g__xeja_class_alpha_seq
      {
        \__xeja_interchar_gset:nnn {##1} { boundary }
          { \__xeja_interchar_alpha_to_boundary:n {##1} }
        \__xeja_interchar_gset:nnn { boundary } {##1}
          { \__xeja_interchar_boundary_to_alpha:n {##1} }
      }
  }
\cs_new:Npn \__xeja_interchar_gset:nnn #1#2#3
  {
    \tex_global:D \tex_XeTeXinterchartoks:D
      \__xeja_class_use:n {#1} ~ \__xeja_class_use:n {#2} = {#3}
  }
\cs_new:Npn \__xeja_interchar_kanji_to_kanji:nn #1#2
  {
    \__xeja_jfm_use_postcharwd:n {#1}
    \__xeja_baselineshift_end:
    \__xeja_jfm_use_postbreakpenalty:n {#1}
    \__xeja_jfm_use_prebreakpenalty:n {#2}
    \__xeja_jfm_use_glue_kern_or:nnn {#1} {#2}
      { \__xeja_glue:n { \l__xeja_kanjiskip_tl } }
    \__xeja_baselineshift_begin:
    \__xeja_jfm_use_precharwd:n {#2}
    % \iow_term:n { K2K:~#1->#2 }
    \scan_stop:
  }
\cs_new:Npn \__xeja_interchar_kanji_to_alpha:nn #1#2
  {
    \__xeja_jfm_use_postcharwd:n {#1}
    \__xeja_baselineshift_end:
    \__xeja_jfm_use_postbreakpenalty:n {#1}
    \__xeja_jfm_use_glue_kern_or:nnn {#1} { kanji/default }
      {
        \__xeja_jfm_if_xspmode_inhibit:nnF {#1} {#2}
          { \__xeja_glue:n { \l__xeja_xkanjiskip_tl } }
      }
    \__xeja_leave_kanji_font:
    % \iow_term:n { K2A:~#1->#2 }
    \scan_stop:
  }
\cs_new:Npn \__xeja_interchar_alpha_to_kanji:nn #1#2
  {
    \__xeja_enter_kanji_font:
    \__xeja_jfm_use_prebreakpenalty:n {#2}
    \__xeja_jfm_use_glue_kern_or:nnn { kanji/default } {#2}
      {
        \__xeja_jfm_if_xspmode_inhibit:nnF {#1} {#2}
          { \__xeja_glue:n { \l__xeja_xkanjiskip_tl } }
      }
    \__xeja_baselineshift_begin:
    \__xeja_jfm_use_precharwd:n {#2}
    % \iow_term:n { A2K:~#1->#2 }
    \scan_stop:
  }
\cs_new:Npn \__xeja_interchar_kanji_to_boundary:n #1
  {
    \__xeja_jfm_use_postcharwd:n {#1}
    \__xeja_baselineshift_end:
    \__xeja_jfm_use_postbreakpenalty:n {#1}
    \__xeja_leave_kanji_font:
    % \iow_term:n { K2B:~#1->boundary }
    \scan_stop:
    \peek_catcode_ignore_spaces:NTF \c_math_toggle_token
      {
        \__xeja_jfm_use_glue_kern_or:nnn {#1} { kanji/default }
          {
            \__xeja_jfm_if_xspmode_inhibit:nnF {#1} { kanji/default }
              { \__xeja_glue:n { \l__xeja_xkanjiskip_tl } }
          }
      }
      {
        \__xeja_lastnode_kanji:n {#1}
      }
  }
\cs_new:Npn \__xeja_interchar_boundary_to_kanji:n #1
  {
    \__xeja_lastnode_check:
    \__xeja_enter_kanji_font:
    \__xeja_jfm_use_prebreakpenalty:n {#1}
    \__xeja_lastnode_switch:nnn
      {
        \__xeja_jfm_use_glue_kern_or:nnn { kanji/default } {#1}
          {
            \__xeja_jfm_if_xspmode_inhibit:nnF { kanji/default } {#1}
              { \__xeja_glue:n { \l__xeja_xkanjiskip_tl } }
          }
      }
      {
        \__xeja_jfm_use_glue_kern_or:nnn
          { \g__xeja_lastnode_class_tl } {#1}
          { \__xeja_glue:n { \l__xeja_kanjiskip_tl } }
      }
      {
        \__xeja_jfm_use_glue_kern_or:nnn
          { kanji/default } { \g__xeja_lastnode_class_tl }
          {
            \__xeja_jfm_if_xspmode_inhibit:nnF
              {#1} { \g__xeja_lastnode_class_tl }
              { \__xeja_glue:n { \l__xeja_xkanjiskip_tl } }
          }
      }
    \__xeja_baselineshift_begin:
    \__xeja_jfm_use_precharwd:n {#1}
    \__xeja_lastnode_clear:
    % \iow_term:n { B2K:~boundary->#1 }
    \scan_stop:
  }
\cs_new:Npn \__xeja_interchar_alpha_to_boundary:n #1
  {
    \__xeja_lastnode_alpha:n {#1}
    % \iow_term:n { A2B:~#1->boundary }
    \scan_stop:
  }
\cs_new:Npn \__xeja_interchar_boundary_to_alpha:n #1
  {
    \__xeja_lastnode_check:
    \__xeja_lastnode_switch:nnn
      {}
      {
        \__xeja_jfm_use_glue_kern_or:nnn
          { \g__xeja_lastnode_class_tl } { kanji/default }
          {
            \__xeja_jfm_if_xspmode_inhibit:nnF
              { \g__xeja_lastnode_class_tl } {#1}
              { \__xeja_glue:n { \l__xeja_xkanjiskip_tl } }
          }
      }
      {}
    \__xeja_lastnode_clear:
    % \iow_term:n { B2A:~boundary->#1 }
    \scan_stop:
  }
\bool_new:N \l__xeja_lastnode_math_bool
\bool_new:N \g__xeja_lastnode_kanji_bool
\bool_new:N \g__xeja_lastnode_alpha_bool
\tl_new:N \g__xeja_lastnode_class_tl
\cs_new:Npn \__xeja_lastnode_kanji:n #1
  {
    \bool_gset_true:N \g__xeja_lastnode_kanji_bool
    \bool_gset_false:N \g__xeja_lastnode_alpha_bool
    \tl_gset:Nn \g__xeja_lastnode_class_tl {#1}
  }
\cs_new:Npn \__xeja_lastnode_alpha:n #1
  {
    \bool_gset_false:N \g__xeja_lastnode_kanji_bool
    \bool_gset_true:N \g__xeja_lastnode_alpha_bool
    \tl_gset:Nn \g__xeja_lastnode_class_tl {#1}
  }
\cs_new:Npn \__xeja_lastnode_clear:
  {
    \bool_gset_false:N \g__xeja_lastnode_kanji_bool
    \bool_gset_false:N \g__xeja_lastnode_alpha_bool
  }
\cs_new:Npn \__xeja_lastnode_check:
  {
    \bool_set_false:N \l__xeja_lastnode_math_bool
    \int_case:nn { \tex_lastnodetype:D }
      {
        { -1 }
        {
          \__xeja_lastnode_clear:
        }
        {  1 }
        {
          \__xeja_lastnode_clear:
        }
        {  2 }
        {
          \__xeja_lastnode_clear:
        }
        { 10 }
        {
          \__xeja_lastnode_clear:
          \bool_set_true:N \l__xeja_lastnode_math_bool
        }
        { 11 }
        {
          \__xeja_lastnode_clear:
        }
        { 12 }
        {
          \dim_compare:nNnF { \tex_lastkern:D } = { \c_zero_dim }
            {
              \__xeja_lastnode_clear:
            }
        }
      }
  }
\cs_new:Npn \__xeja_lastnode_switch:nnn #1#2#3
  {
    \bool_case_true:n
      {
        { \l__xeja_lastnode_math_bool } {#1}
        { \g__xeja_lastnode_kanji_bool } {#2}
        { \g__xeja_lastnode_alpha_bool } {#3}
      }
  }
\dim_new:N \l__xeja_baselineshift_dim
\cs_new:Npn \__xeja_baselineshift_begin:
  {
    \dim_set:Nn \l__xeja_baselineshift_dim
      {
        \xeja_if_tate_text:TF
          { \l__xeja_tbaselineshift_tl }
          { \l__xeja_ybaselineshift_tl }
      }
    \dim_compare:nNnF { \l__xeja_baselineshift_dim } = { \c_zero_dim }
      {
        \tex_raise:D \l__xeja_baselineshift_dim
          \tex_hbox:D \c_group_begin_token
      }
  }
\cs_new:Npn \__xeja_baselineshift_end:
  {
    \dim_compare:nNnF { \l__xeja_baselineshift_dim } = { \c_zero_dim }
      {
        \c_group_end_token
        \__xeja_kern:n { \c_zero_dim }
      }
  }
\cs_new:Npn \xeja_set_kanjiskip:n #1
  {
    \tl_set:Nn \l__xeja_kanjiskip_tl {#1}
  }
\cs_new:Npn \xeja_get_kanjiskip:
  {
    \l__xeja_kanjiskip_tl
  }
\cs_new:Npn \xeja_set_xkanjiskip:n #1
  {
    \tl_set:Nn \l__xeja_xkanjiskip_tl {#1}
  }
\cs_new:Npn \xeja_get_xkanjiskip:
  {
    \l__xeja_xkanjiskip_tl
  }
\cs_new:Npn \__xeja_jfm_exp_args_param:Nnn #1#2#3
  {
    \exp_args:Nc #1 { l__xeja_jfm_#2_#3_tl }
  }
\cs_new:Npn \__xeja_jfm_exp_args_param:Nnnn #1#2#3#4
  {
    \exp_args:Nc #1 { l__xeja_jfm_#2_#3->#4_tl }
  }
\cs_new:Npn \__xeja_jfm_set_param:nnn #1#2#3
  {
    \__xeja_jfm_exp_args_param:Nnn
      \__xeja_jfm_set_param:Nn {#1} {#2}
        {#3}
  }
\cs_new:Npn \__xeja_jfm_set_param:nnnn #1#2#3#4
  {
    \__xeja_jfm_exp_args_param:Nnnn
      \__xeja_jfm_set_param:Nn {#1} {#2} {#3}
        {#4}
  }
\cs_new:Npn \__xeja_jfm_set_param:Nn #1#2
  {
    \tl_if_exist:NF #1 { \tl_new:N #1 }
    \tl_set:Nn #1 {#2}
  }
\cs_new:Npn \__xeja_jfm_clear_param:nn #1#2
  {
    \__xeja_jfm_exp_args_param:Nnn
      \__xeja_jfm_clear_param:N {#1} {#2}
  }
\cs_new:Npn \__xeja_jfm_clear_param:nnn #1#2#3
  {
    \__xeja_jfm_exp_args_param:Nnnn
      \__xeja_jfm_clear_param:N {#1} {#2} {#3}
  }
\cs_new:Npn \__xeja_jfm_clear_param:N #1
  {
    \tl_if_exist:NF #1 { \tl_clear:N #1 }
  }
\cs_new:Npn \__xeja_jfm_if_exist_use_param:nnTF #1#2#3#4
  {
    \__xeja_jfm_exp_args_param:Nnn
      \__xeja_jfm_if_exist_use_param:NTF {#1} {#2}
        {#3} {#4}
  }
\cs_new:Npn \__xeja_jfm_if_exist_use_param:nnnTF #1#2#3#4#5
  {
    \__xeja_jfm_exp_args_param:Nnnn
      \__xeja_jfm_if_exist_use_param:NTF {#1} {#2} {#3}
        {#4} {#5}
  }
\cs_new:Npn \__xeja_jfm_if_exist_use_param:NTF #1#2#3
  {
    \tl_if_exist:NTF #1
      { \tl_if_empty:NTF #1 {#3} { #1 #2 } }
      {#3}
  }
\cs_new_eq:NN \__xeja_glue:n \skip_horizontal:n
\cs_new:Npn \__xeja_kern:n #1
  { \tex_kern:D \dim_eval:n {#1} }
\cs_new:Npn \__xeja_vrule_zero:
  { \tex_vrule:D width \c_zero_dim \scan_stop: }
\cs_new:Npn \__xeja_penalty:n #1
  { \tex_penalty:D \int_eval:n {#1} \exp_stop_f: }
\cs_new:Npn \xeja_jfm_set_glue:nnn #1#2#3
  {
    \__xeja_jfm_set_param:nnnn { glue_kern } {#1} {#2}
      { \__xeja_glue:n {#3} }
  }
\cs_new:Npn \xeja_jfm_set_kern:nnn #1#2#3
  {
    \__xeja_jfm_set_param:nnnn { glue_kern } {#1} {#2}
      { \__xeja_kern:n {#3} }
  }
\cs_new:Npn \xeja_jfm_clear_glue_kern:nn #1#2
  {
    \__xeja_jfm_clear_param:nnn { glue_kern } {#1} {#2}
  }
\cs_new:Npn \__xeja_jfm_use_glue_kern_or:nnn #1#2#3
  {
    \__xeja_jfm_if_exist_use_param:nnnTF { glue_kern } {#1} {#2} {} {#3}
  }
\cs_new:Npn \__xeja_jfm_precharwd:n #1
  { \__xeja_vrule_zero: \__xeja_kern:n {#1} }
\cs_new:Npn \__xeja_jfm_postcharwd:n #1
  { \__xeja_kern:n {#1} \__xeja_vrule_zero: }
\cs_new:Npn \xeja_jfm_set_precharwd:nn #1#2
  {
    \__xeja_jfm_set_param:nnn { precharwd } {#1}
      { \__xeja_jfm_precharwd:n {#2} }
  }
\cs_new:Npn \xeja_jfm_set_postcharwd:nn #1#2
  {
    \__xeja_jfm_set_param:nnn { postcharwd } {#1}
      { \__xeja_jfm_postcharwd:n {#2} }
  }
\cs_new:Npn \xeja_jfm_clear_precharwd:n #1
  {
    \__xeja_jfm_clear_param:nn { precharwd } {#1}
  }
\cs_new:Npn \xeja_jfm_clear_postcharwd:n #1
  {
    \__xeja_jfm_clear_param:nn { postcharwd } {#1}
  }
\cs_new:Npn \__xeja_jfm_use_precharwd:n #1
  { \__xeja_jfm_if_exist_use_param:nnTF { precharwd } {#1} {} {} }
\cs_new:Npn \__xeja_jfm_use_postcharwd:n #1
  { \__xeja_jfm_if_exist_use_param:nnTF { postcharwd } {#1} {} {} }
\cs_new:Npn \xeja_jfm_set_prebreakpenalty:nn #1#2
  {
    \__xeja_jfm_set_param:nnn { prebreakpenalty } {#1}
      { \__xeja_penalty:n {#2} }
  }
\cs_new:Npn \xeja_jfm_set_postbreakpenalty:nn #1#2
  {
    \__xeja_jfm_set_param:nnn { postbreakpenalty } {#1}
      { \__xeja_penalty:n {#2} }
  }
\cs_new:Npn \xeja_jfm_clear_prebreakpenalty:n #1
  {
    \__xeja_jfm_clear_param:nn { prebreakpenalty } {#1}
  }
\cs_new:Npn \xeja_jfm_clear_postbreakpenalty:n #1
  {
    \__xeja_jfm_clear_param:nn { postbreakpenalty } {#1}
  }
\cs_new:Npn \__xeja_jfm_use_prebreakpenalty:n #1
  { \__xeja_jfm_if_exist_use_param:nnTF { prebreakpenalty } {#1} {} {} }
\cs_new:Npn \__xeja_jfm_use_postbreakpenalty:n #1
  { \__xeja_jfm_if_exist_use_param:nnTF { postbreakpenalty } {#1} {} {} }
\cs_new:Npn \xeja_jfm_set_xspmode:nn #1#2
  {
    \str_case:nnF {#2}
      {
        { inhibit }
        { \__xeja_jfm_set_param:nnn { xspmode } {#1} { 0 } }
        { preonly }
        { \__xeja_jfm_set_param:nnn { xspmode } {#1} { 1 } }
        { postonly }
        { \__xeja_jfm_set_param:nnn { xspmode } {#1} { 2 } }
        { allow }
        { \__xeja_jfm_set_param:nnn { xspmode } {#1} { 3 } }
      }
      { \msg_error:nnn { xelatexja } { unknown-xspmode } {#2} }
  }
\msg_new:nnnn { xelatexja } { unknown-xspmode }
  { Unknown~xspmode~'#1'.~Perhaps~a~misspelling?. }
  {
    The~xspmode~used~not~known.~
    Allowed~values~are~'inhibit',~'preonly',~'postonly'~or~'allow'.
  }
\cs_new:Npn \__xeja_jfm_use_xspmode:n #1
  { \__xeja_jfm_if_exist_use_param:nnTF { xspmode } {#1} {} { 3 } }
\cs_new:Npn \__xeja_jfm_if_xspmode_preinhibit_p:n #1
  {
    \int_case:nnF { \__xeja_jfm_use_xspmode:n {#1} }
      {
        { 0 } { \c_true_bool }
        { 2 } { \c_true_bool }
      }
      { \c_false_bool }
  }
\cs_new:Npn \__xeja_jfm_if_xspmode_postinhibit_p:n #1
  {
    \int_case:nnF { \__xeja_jfm_use_xspmode:n {#1} }
      {
        { 0 } { \c_true_bool }
        { 1 } { \c_true_bool }
      }
      { \c_false_bool }
  }
\cs_new:Npn \__xeja_jfm_if_xspmode_inhibit:nnF #1#2#3
  {
    \bool_lazy_or:nnF
      { \__xeja_jfm_if_xspmode_postinhibit_p:n {#1} }
      { \__xeja_jfm_if_xspmode_preinhibit_p:n {#2} }
      {#3}
  }
\cs_set_eq:NN \__xeja_special:n \tex_special:D
\cs_new:Npn \__xeja_graphics_save:
  { \__xeja_special:n { x:gsave } }
\cs_new:Npn \__xeja_graphics_restore:
  { \__xeja_special:n { x:grestore } }
\cs_new:Npn \__xeja_graphics_rotate:n #1
  { \__xeja_special:n { x:rotate~ #1 } }
\box_new:N \l__xeja_rotate_box
\dim_new:N \l__xeja_rotate_box_ht_dim
\dim_new:N \l__xeja_rotate_box_dp_dim
\dim_new:N \l__xeja_rotate_box_wd_dim
\cs_new:Npn \__xeja_rotate_box_tate_in_yoko:N #1
  {
    \dim_set:Nn \l__xeja_rotate_box_ht_dim { \box_ht:N #1 }
    \dim_set:Nn \l__xeja_rotate_box_dp_dim { \box_dp:N #1 }
    \dim_set:Nn \l__xeja_rotate_box_wd_dim { \box_wd:N #1 }
    \hbox_set:Nn \l__xeja_rotate_box
      {
        \tex_kern:D -\l__xeja_rotate_box_wd_dim
        \box_use:N #1
      }
    \hbox_set:Nn \l__xeja_rotate_box
      {
        \__xeja_graphics_save:
        \__xeja_graphics_rotate:n { -90 }
        \box_use:N \l__xeja_rotate_box
        \__xeja_graphics_restore:
      }
    \hbox_set:Nn \l__xeja_rotate_box
      {
        \tex_kern:D \l__xeja_rotate_box_dp_dim
        \box_use:N \l__xeja_rotate_box
      }
    \box_set_ht:Nn \l__xeja_rotate_box
      { \l__xeja_rotate_box_wd_dim }
    \box_set_dp:Nn \l__xeja_rotate_box { 0pt }
    \box_set_wd:Nn \l__xeja_rotate_box
      { \l__xeja_rotate_box_ht_dim + \l__xeja_rotate_box_dp_dim }
    \box_set_eq_drop:NN #1 \l__xeja_rotate_box
  }
\cs_new:Npn \__xeja_rotate_box_yoko_in_tate:N #1
  {
    \dim_set:Nn \l__xeja_rotate_box_ht_dim { \box_ht:N #1 }
    \dim_set:Nn \l__xeja_rotate_box_dp_dim { \box_dp:N #1 }
    \dim_set:Nn \l__xeja_rotate_box_wd_dim { \box_wd:N #1 }
    \hbox_set:Nn \l__xeja_rotate_box
      {
        \tex_kern:D -0.5\l__xeja_rotate_box_wd_dim
        \box_use:N #1
      }
    \hbox_set:Nn \l__xeja_rotate_box
      {
        \__xeja_graphics_save:
        \__xeja_graphics_rotate:n { 90 }
        \box_use:N \l__xeja_rotate_box
        \__xeja_graphics_restore:
      }
    \hbox_set:Nn \l__xeja_rotate_box
      {
        \tex_kern:D \l__xeja_rotate_box_ht_dim
        \box_use:N \l__xeja_rotate_box
      }
    \box_set_ht:Nn \l__xeja_rotate_box
      { 0.5\l__xeja_rotate_box_wd_dim }
    \box_set_dp:Nn \l__xeja_rotate_box
      { 0.5\l__xeja_rotate_box_wd_dim }
    \box_set_wd:Nn \l__xeja_rotate_box
      { \l__xeja_rotate_box_ht_dim + \l__xeja_rotate_box_dp_dim }
    \box_set_eq_drop:NN #1 \l__xeja_rotate_box
  }
\box_new:N \l__xeja_tate_yoko_box
\cs_new:Npn \__xeja_yoko_in_tate_hbox:n #1
  {
    \hbox_set:Nn \l__xeja_tate_yoko_box
      { \bool_set_false:N \l__xeja_tate_text_bool #1 }
    \__xeja_rotate_box_yoko_in_tate:N \l__xeja_tate_yoko_box
    \dim_set:Nn \l__xeja_baselineshift_dim { \l__xeja_tbaselineshift_tl }
    \dim_compare:nNnF { \l__xeja_baselineshift_dim } = { \c_zero_dim }
      {
        \tex_raise:D \l__xeja_baselineshift_dim
        \tex_box:D \l__xeja_tate_yoko_box
      }
    \box_use_drop:N \l__xeja_tate_yoko_box
  }
\cs_new:Npn \__xeja_tate_in_yoko_hbox:n #1
  {
    \hbox_set:Nn \l__xeja_tate_yoko_box
      { \bool_set_true:N \l__xeja_tate_text_bool #1 }
    \__xeja_rotate_box_tate_in_yoko:N \l__xeja_tate_yoko_box
    \dim_set:Nn \l__xeja_baselineshift_dim { \l__xeja_ybaselineshift_tl }
    \dim_compare:nNnF { \l__xeja_baselineshift_dim } = { \c_zero_dim }
      {
        \tex_raise:D \l__xeja_baselineshift_dim
        \tex_box:D \l__xeja_tate_yoko_box
      }
    \box_use_drop:N \l__xeja_tate_yoko_box
  }
\cs_new:Npn \xeja_yoko_hbox:n #1
  {
    \bool_if:NTF \l__xeja_tate_text_bool
      { \__xeja_yoko_in_tate_hbox:n {#1} }
      { \hbox:n {#1} }
  }
\cs_new:Npn \xeja_tate_hbox:n #1
  {
    \bool_if:NTF \l__xeja_tate_text_bool
      { \hbox:n {#1} }
      { \__xeja_tate_in_yoko_hbox:n {#1} }
  }
\cs_set_eq:NN \__xeja_original_output_page: \@outputpage
\cs_set:Npn \@outputpage
  {
    \bool_if:NTF \g__xeja_tate_document_bool
      {
        \group_begin:
          \__xeja_rotate_box_tate_in_yoko:N \@outputbox
          \dim_set_eq:NN \l__xeja_tmpa_dim \textwidth
          \dim_set_eq:NN \textwidth \textheight
          \dim_set_eq:NN \textheight \l__xeja_tmpa_dim
          \bool_set_false:N \l__xeja_tate_text_bool
          \__xeja_original_output_page:
        \group_end:
        \dim_gset_eq:NN \@colht \textheight
      }
      {
        \__xeja_original_output_page:
      }
  }
\cs_new_eq:NN \xejaIfTateDocumentTF \xeja_if_tate_document:TF
\cs_new_eq:NN \xejaIfTateTextTF \xeja_if_tate_text:TF
\input{xejajfm-\g__xeja_jfm_tl.def}
%% 
%%
%% End of file `xelatexja.sty'.
